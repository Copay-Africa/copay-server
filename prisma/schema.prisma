// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// Enums
enum UserRole {
  SUPER_ADMIN
  ORGANIZATION_ADMIN
  TENANT
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING
}

enum AccountRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

enum CooperativeStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING_APPROVAL
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
  REFUNDED
}

enum PaymentMethodType {
  MOBILE_MONEY_MTN // MTN Mobile Money via IremboPay
  MOBILE_MONEY_AIRTEL // Airtel Money via IremboPay
  BANK_BK // Bank of Kigali via IremboPay
  BANK_IM // I&M Bank via IremboPay
  BANK_ECOBANK // Ecobank via IremboPay
}

enum PaymentAmountType {
  FIXED
  PARTIAL_ALLOWED
  FLEXIBLE
}

enum TransactionType {
  PAYMENT
  REFUND
  ADJUSTMENT
  FEE
}

enum ComplaintStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum ComplaintPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum ActivityType {
  LOGIN
  LOGOUT
  PAYMENT_INITIATED
  PAYMENT_COMPLETED
  PAYMENT_FAILED
  PAYMENT_CANCELLED
  PIN_RESET_REQUESTED
  PIN_RESET_COMPLETED
  PROFILE_UPDATED
  COOPERATIVE_JOINED
  COOPERATIVE_LEFT
  COMPLAINT_CREATED
  COMPLAINT_UPDATED
  ACCOUNT_SUSPENDED
  ACCOUNT_ACTIVATED
  SECURITY_ALERT
  TRANSACTION_REFUND
  PAYMENT_TYPE_ACCESSED
  API_ACCESS
  FAILED_LOGIN_ATTEMPT
}

enum ReminderType {
  PAYMENT_DUE
  PAYMENT_OVERDUE
  PAYMENT_UPCOMING
  CUSTOM
}

enum ReminderStatus {
  ACTIVE
  INACTIVE
  COMPLETED
  CANCELLED
}

enum NotificationStatus {
  PENDING
  SENT
  FAILED
  DELIVERED
}

enum NotificationType {
  SMS
  EMAIL
  IN_APP
  PUSH_NOTIFICATION
}

enum AnnouncementStatus {
  DRAFT
  SCHEDULED
  SENDING
  SENT
  CANCELLED
}

enum AnnouncementTargetType {
  ALL_TENANTS
  ALL_ORGANIZATION_ADMINS
  SPECIFIC_COOPERATIVE
  SPECIFIC_USERS
}

enum AnnouncementPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

// Models
model Cooperative {
  id          String            @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  code        String            @unique
  description String?
  address     String?
  phone       String?
  email       String?
  status      CooperativeStatus @default(PENDING_APPROVAL)
  settings    Json? // Flexible settings storage

  // Relationships
  users               User[]
  paymentTypes        PaymentType[]
  payments            Payment[]
  paymentTransactions PaymentTransaction[]
  transactions        Transaction[]
  complaints          Complaint[]
  accountRequests     AccountRequest[]
  activities          Activity[]
  reminders           Reminder[]
  notifications       Notification[]
  announcements       Announcement[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("cooperatives")
}

model User {
  id        String     @id @default(auto()) @map("_id") @db.ObjectId
  phone     String     @unique
  pin       String // Hashed 4-digit PIN
  firstName String?
  lastName  String?
  email     String?
  role      UserRole   @default(TENANT)
  status    UserStatus @default(PENDING)

  // Multi-tenancy
  cooperativeId String?      @db.ObjectId
  cooperative   Cooperative? @relation(fields: [cooperativeId], references: [id])

  // Profile data
  profileData Json? // Flexible profile storage

  // Security
  lastLoginAt          DateTime?
  passwordResetToken   String?
  passwordResetExpires DateTime?

  // Push notifications
  fcmToken          String? // Firebase Cloud Messaging token
  fcmTokenUpdatedAt DateTime? // When FCM token was last updated

  // Relationships
  sentPayments             Payment[]        @relation("PaymentSender")
  receivedPayments         Payment[]        @relation("PaymentReceiver")
  transactions             Transaction[]
  complaints               Complaint[]
  processedAccountRequests AccountRequest[] @relation("AccountRequestProcessor")
  accountRequest           AccountRequest?  @relation("AccountRequestUser")
  activities               Activity[]
  reminders                Reminder[]
  notifications            Notification[]
  createdAnnouncements     Announcement[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

model PaymentType {
  id          String            @id @default(auto()) @map("_id") @db.ObjectId
  name        String // e.g., "Rent", "Security Deposit", "Cleaning Fee"
  description String?
  amount      Float // Base amount
  amountType  PaymentAmountType @default(FIXED)
  isActive    Boolean           @default(true)

  // Multi-tenancy
  cooperativeId String      @db.ObjectId
  cooperative   Cooperative @relation(fields: [cooperativeId], references: [id])

  // Payment settings
  allowPartialPayment Boolean @default(false)
  minimumAmount       Float? // For partial payments
  dueDay              Int? // Day of month when due (1-31)
  isRecurring         Boolean @default(false)

  // Metadata
  settings Json? // Additional flexible settings

  // Relationships
  payments  Payment[]
  reminders Reminder[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([cooperativeId, name]) // Prevent duplicate names per cooperative
  @@map("payment_types")
}

model Payment {
  id          String        @id @default(auto()) @map("_id") @db.ObjectId
  amount      Float
  status      PaymentStatus @default(PENDING)
  description String?
  dueDate     DateTime?

  // Payment Type relationship
  paymentTypeId String      @db.ObjectId
  paymentType   PaymentType @relation(fields: [paymentTypeId], references: [id])

  // Payment method details
  paymentMethod    PaymentMethodType?
  paymentReference String? // External payment reference
  invoiceNumber    String? // Invoice number from payment gateway
  idempotencyKey   String?            @unique // For preventing duplicate payments

  // Multi-tenancy
  cooperativeId String      @db.ObjectId
  cooperative   Cooperative @relation(fields: [cooperativeId], references: [id])

  // Relationships
  senderId String @db.ObjectId
  sender   User   @relation("PaymentSender", fields: [senderId], references: [id])

  receiverId String? @db.ObjectId
  receiver   User?   @relation("PaymentReceiver", fields: [receiverId], references: [id])

  // Payment gateway data
  gatewayTransactionId String?
  gatewayResponse      Json?

  // Group payment support
  isGroupPayment   Boolean @default(false)
  groupPaymentData Json? // Store group payment details

  // Transactions
  transactions  PaymentTransaction[]
  notifications Notification[]

  // Timestamps
  paidAt    DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@map("payments")
}

model PaymentTransaction {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  // Payment reference
  paymentId String  @db.ObjectId
  payment   Payment @relation(fields: [paymentId], references: [id])

  // Transaction details
  amount        Float
  status        PaymentStatus     @default(PENDING)
  paymentMethod PaymentMethodType

  // External gateway details
  gatewayTransactionId String? @unique
  gatewayReference     String?
  gatewayResponse      Json? // Raw gateway response

  // Processing details
  processingStartedAt   DateTime?
  processingCompletedAt DateTime?
  failureReason         String?

  // Webhook details
  webhookReceived   Boolean   @default(false)
  webhookReceivedAt DateTime?
  webhookData       Json?

  // Idempotency
  idempotencyKey String @unique

  // Multi-tenancy
  cooperativeId String      @db.ObjectId
  cooperative   Cooperative @relation(fields: [cooperativeId], references: [id])

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("payment_transactions")
}

model Transaction {
  id          String          @id @default(auto()) @map("_id") @db.ObjectId
  amount      Float
  type        TransactionType
  description String?
  reference   String?         @unique

  // Multi-tenancy
  cooperativeId String      @db.ObjectId
  cooperative   Cooperative @relation(fields: [cooperativeId], references: [id])

  // Relationships
  userId String @db.ObjectId
  user   User   @relation(fields: [userId], references: [id])

  // Payment gateway data
  gatewayData Json?

  // Metadata
  metadata Json?

  // Timestamps
  processedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("transactions")
}

model Complaint {
  id          String            @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  description String
  status      ComplaintStatus   @default(OPEN)
  priority    ComplaintPriority @default(MEDIUM)

  // Multi-tenancy
  cooperativeId String      @db.ObjectId
  cooperative   Cooperative @relation(fields: [cooperativeId], references: [id])

  // Relationships
  userId String @db.ObjectId
  user   User   @relation(fields: [userId], references: [id])

  // Resolution
  resolution String?
  resolvedAt DateTime?

  // Attachments
  attachments Json? // Store file URLs/metadata

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("complaints")
}

model AccountRequest {
  id              String               @id @default(auto()) @map("_id") @db.ObjectId
  fullName        String
  phone           String
  cooperativeId   String               @db.ObjectId
  cooperative     Cooperative          @relation(fields: [cooperativeId], references: [id])
  roomNumber      String // Room/Unit number
  status          AccountRequestStatus @default(PENDING)
  rejectionReason String? // Reason for rejection if applicable

  // Admin who processed the request
  processedBy   String?   @db.ObjectId
  processedUser User?     @relation("AccountRequestProcessor", fields: [processedBy], references: [id])
  processedAt   DateTime?

  // Generated user (if approved)
  userId String? @unique @db.ObjectId
  user   User?   @relation("AccountRequestUser", fields: [userId], references: [id])

  // Metadata
  notes       String? // Admin notes
  requestData Json? // Additional request data

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([phone, cooperativeId]) // Prevent duplicate requests per cooperative
  @@map("account_requests")
}

model Activity {
  id          String       @id @default(auto()) @map("_id") @db.ObjectId
  type        ActivityType
  title       String // Human-readable activity title
  description String? // Detailed description

  // User who performed the activity
  userId String @db.ObjectId
  user   User   @relation(fields: [userId], references: [id])

  // Multi-tenancy
  cooperativeId String?      @db.ObjectId
  cooperative   Cooperative? @relation(fields: [cooperativeId], references: [id])

  // Activity metadata
  metadata Json? // Additional context data (payment IDs, amounts, etc.)

  // Request context
  ipAddress String? // User's IP address
  userAgent String? // User's browser/device info

  // Related entities (optional references)
  relatedPaymentId   String? @db.ObjectId // Link to payment if applicable
  relatedComplaintId String? @db.ObjectId // Link to complaint if applicable

  // Security context
  isSecurityEvent Boolean @default(false) // Mark security-related activities
  riskLevel       String? // LOW, MEDIUM, HIGH for security events

  // Timestamps
  occurredAt DateTime @default(now()) // When the activity occurred
  createdAt  DateTime @default(now())

  @@index([userId, occurredAt]) // Optimize for user activity queries
  @@index([type, occurredAt]) // Optimize for activity type queries
  @@index([cooperativeId, occurredAt]) // Optimize for cooperative activity queries
  @@map("activities")
}

model Reminder {
  id          String         @id @default(auto()) @map("_id") @db.ObjectId
  title       String // User-defined reminder title
  description String? // Optional description
  type        ReminderType
  status      ReminderStatus @default(ACTIVE)

  // User who created the reminder
  userId String @db.ObjectId
  user   User   @relation(fields: [userId], references: [id])

  // Multi-tenancy
  cooperativeId String?      @db.ObjectId
  cooperative   Cooperative? @relation(fields: [cooperativeId], references: [id])

  // Related payment type (optional)
  paymentTypeId String?      @db.ObjectId
  paymentType   PaymentType? @relation(fields: [paymentTypeId], references: [id])

  // Reminder timing
  reminderDate     DateTime // When to send the reminder
  isRecurring      Boolean  @default(false)
  recurringPattern String? // DAILY, WEEKLY, MONTHLY, etc.

  // Notification preferences
  notificationTypes String[] // Array of NotificationType values
  advanceNoticeDays Int      @default(0) // Days before due date to remind

  // Custom reminder data
  customAmount Float? // For custom payment amounts
  notes        String? // Additional notes

  // Reminder execution tracking
  lastTriggered DateTime?
  nextTrigger   DateTime?
  triggerCount  Int       @default(0)

  // Metadata
  metadata Json? // Additional flexible data

  // Relationships
  notifications Notification[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, status, nextTrigger]) // Optimize for user reminder queries
  @@index([status, nextTrigger]) // Optimize for reminder processing
  @@index([cooperativeId, status]) // Optimize for cooperative queries
  @@map("reminders")
}

model Notification {
  id      String             @id @default(auto()) @map("_id") @db.ObjectId
  type    NotificationType
  status  NotificationStatus @default(PENDING)
  title   String
  message String

  // Recipient
  userId String @db.ObjectId
  user   User   @relation(fields: [userId], references: [id])

  // Multi-tenancy
  cooperativeId String?      @db.ObjectId
  cooperative   Cooperative? @relation(fields: [cooperativeId], references: [id])

  // Related entities
  reminderId String?   @db.ObjectId
  reminder   Reminder? @relation(fields: [reminderId], references: [id])

  paymentId String?  @db.ObjectId
  payment   Payment? @relation(fields: [paymentId], references: [id])

  announcementId String?       @db.ObjectId
  announcement   Announcement? @relation(fields: [announcementId], references: [id])

  // Delivery details
  recipient String // Phone number, email, or device token

  // Processing details
  sentAt       DateTime?
  deliveredAt  DateTime?
  failedAt     DateTime?
  errorMessage String? // Error details if failed

  // Provider response
  providerResponse Json? // Response from SMS/Email provider

  // Retry logic
  retryCount  Int       @default(0)
  maxRetries  Int       @default(3)
  nextRetryAt DateTime?

  // Metadata
  metadata Json?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, status, type]) // Optimize for user notification queries
  @@index([status, nextRetryAt]) // Optimize for retry processing
  @@index([reminderId, status]) // Optimize for reminder notifications
  @@map("notifications")
}

// Announcements
model Announcement {
  id String @id @default(auto()) @map("_id") @db.ObjectId

  // Basic Information
  title    String
  message  String
  priority AnnouncementPriority @default(NORMAL)
  status   AnnouncementStatus   @default(DRAFT)

  // Targeting
  targetType           AnnouncementTargetType
  targetCooperativeIds String[]               @db.ObjectId // For SPECIFIC_COOPERATIVE targeting
  targetUserIds        String[]               @db.ObjectId // For SPECIFIC_USERS targeting

  // Notification Channels
  notificationTypes NotificationType[] // Which channels to use for sending

  // Scheduling
  scheduledAt DateTime? // When to send (null for immediate)
  sentAt      DateTime? // When it was actually sent

  // Creator Information
  createdById String @db.ObjectId
  createdBy   User   @relation(fields: [createdById], references: [id])

  // Cooperative Context (for organization admins)
  cooperativeId String?      @db.ObjectId
  cooperative   Cooperative? @relation(fields: [cooperativeId], references: [id])

  // Statistics
  totalRecipients Int @default(0)
  sentCount       Int @default(0)
  deliveredCount  Int @default(0)
  failedCount     Int @default(0)

  // Related notifications
  notifications Notification[]

  // Metadata for additional settings
  metadata Json?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status, scheduledAt]) // Optimize for scheduled announcements processing
  @@index([createdById, cooperativeId]) // Optimize for user's announcements
  @@index([targetType, status]) // Optimize for targeting queries
  @@map("announcements")
}
